# AWS Cache System - 処理フロー図解

## 1. メイン処理フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                    AWS Cache System 開始                        │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                  コマンドライン引数解析                          │
│  • -t/--ttl: キャッシュ有効期限                                 │
│  • -f/--force: 強制更新                                        │
│  • -d/--debug: デバッグモード                                  │
│  • -l/--list: キャッシュ一覧                                   │
│  • -c/--clear: キャッシュクリア                                │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
              ┌───────────────┐
              │  アクション判定  │
              └───────┬───────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ AWS実行     │ │ キャッシュ   │ │ キャッシュ   │
│ (execute)   │ │ 一覧表示     │ │ クリア       │
│             │ │ (list)      │ │ (clear)     │
└─────────────┘ └─────────────┘ └─────────────┘
```

## 2. AWS実行処理の詳細フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                    AWS実行処理開始                              │
│              ./aws_cache.sh -- aws s3api list-buckets          │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                キャッシュキー生成                                │
│         MD5ハッシュ("aws s3api list-buckets --output json")     │
│                → abc123def456...                               │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              キャッシュファイルパス生成                          │
│            ./aws_cache/abc123def456.json                       │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
              ┌───────────────┐
              │ 強制更新？     │
              │ (-f オプション) │
              └───────┬───────┘
                      │
                 ┌────┴────┐
                 │ YES     │ NO
                 ▼         ▼
        ┌─────────────┐ ┌─────────────┐
        │ キャッシュ   │ │ キャッシュ   │
        │ 無視して     │ │ 有効性チェック│
        │ API実行     │ │             │
        └─────────────┘ └──────┬──────┘
                               │
                        ┌──────┴──────┐
                        │ 有効？       │
                        └──────┬──────┘
                               │
                          ┌────┴────┐
                          │ YES     │ NO
                          ▼         ▼
                 ┌─────────────┐ ┌─────────────┐
                 │ キャッシュ   │ │ AWS API     │
                 │ から返却     │ │ 実行        │
                 └─────────────┘ └─────────────┘
```

## 3. キャッシュ有効性チェック

```
┌─────────────────────────────────────────────────────────────────┐
│                  キャッシュ有効性チェック                        │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              キャッシュファイル存在確認                          │
│                ./aws_cache/abc123.json                         │
└─────────────────────┬───────────────────────────────────────────┘
                      │
              ┌───────┴───────┐
              │ ファイル存在？  │
              └───────┬───────┘
                      │
                 ┌────┴────┐
                 │ YES     │ NO
                 ▼         ▼
        ┌─────────────┐ ┌─────────────┐
        │ ファイル更新 │ │ 無効        │
        │ 時刻取得     │ │ (false)     │
        └──────┬──────┘ └─────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    TTL計算                                     │
│  現在時刻 < (ファイル更新時刻 + TTL秒) ?                        │
└─────────────────────┬───────────────────────────────────────────┘
                      │
              ┌───────┴───────┐
              │ 期限内？       │
              └───────┬───────┘
                      │
                 ┌────┴────┐
                 │ YES     │ NO
                 ▼         ▼
        ┌─────────────┐ ┌─────────────┐
        │ 有効        │ │ 無効        │
        │ (true)      │ │ (false)     │
        └─────────────┘ └─────────────┘
```

## 4. キャッシュからの取得処理

```
┌─────────────────────────────────────────────────────────────────┐
│                  キャッシュから取得                              │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              デバッグログ出力（オプション）                      │
│         debug_log "📦 キャッシュから取得: aws s3api..."          │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                キャッシュファイル読み込み                        │
│                                                                │
│  {                                                             │
│    "command": ["aws", "s3api", "list-buckets", "--output", "json"], │
│    "response": { "Buckets": [...] },  ← この部分を抽出          │
│    "timestamp": "2024-01-01T12:00:00+09:00",                  │
│    "ttl": 3600                                                │
│  }                                                             │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              jq -M '.response' でレスポンス抽出                  │
│                                                                │
│  入力: キャッシュファイル全体                                    │
│  出力: { "Buckets": [...] }  ← オリジナルレスポンスのみ         │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    標準出力に出力                               │
│              （カラー出力なし、純粋なJSON）                      │
└─────────────────────────────────────────────────────────────────┘
```

## 5. AWS API実行とキャッシュ保存処理

```
┌─────────────────────────────────────────────────────────────────┐
│                    AWS API実行                                 │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              デバッグログ出力（オプション）                      │
│         debug_log "🔄 AWS APIを実行: aws s3api..."              │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              --output json オプション自動追加                   │
│  コマンドに --output が含まれていない場合のみ追加                │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                  AWS CLI実行                                   │
│         aws s3api list-buckets --output json                   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
              ┌───────┴───────┐
              │ 実行成功？     │
              └───────┬───────┘
                      │
                 ┌────┴────┐
                 │ YES     │ NO
                 ▼         ▼
        ┌─────────────┐ ┌─────────────┐
        │ レスポンス   │ │ エラー出力   │
        │ 取得        │ │ 処理終了     │
        └──────┬──────┘ └─────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────────────────┐
│                キャッシュデータ構築                              │
│  {                                                             │
│    "command": ["aws", "s3api", "list-buckets", "--output", "json"], │
│    "response": <AWS APIレスポンス>,                             │
│    "timestamp": "2024-01-01T12:00:00+09:00",                  │
│    "ttl": 3600                                                │
│  }                                                             │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              キャッシュファイルに保存                            │
│            ./aws_cache/abc123def456.json                       │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              デバッグログ出力（オプション）                      │
│      debug_log "💾 レスポンスをキャッシュに保存: ..."            │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              オリジナルレスポンスを標準出力                      │
│                （キャッシュと同じ内容）                          │
└─────────────────────────────────────────────────────────────────┘
```

## 6. デバッグモードの動作

```
┌─────────────────────────────────────────────────────────────────┐
│                  デバッグモード判定                              │
│                DEBUG_MODE=true ?                               │
└─────────────────────┬───────────────────────────────────────────┘
                      │
              ┌───────┴───────┐
              │ デバッグON？   │
              └───────┬───────┘
                      │
                 ┌────┴────┐
                 │ YES     │ NO
                 ▼         ▼
        ┌─────────────┐ ┌─────────────┐
        │ ログ出力     │ │ ログ非表示   │
        │ (stderr)    │ │             │
        │             │ │             │
        │ 📦 キャッシュ │ │             │
        │ 🔄 API実行   │ │             │
        │ 💾 保存      │ │             │
        │ 🗑️ 削除      │ │             │
        └─────────────┘ └─────────────┘
                 │             │
                 └─────┬───────┘
                       │
                       ▼
        ┌─────────────────────────────┐
        │      レスポンス出力          │
        │    （常に標準出力）          │
        └─────────────────────────────┘
```

## 7. キャッシュファイル構造

```
aws_cache/
├── abc123def456.json  ← MD5ハッシュファイル名
├── 789ghi012jkl.json
└── ...

各ファイルの内容:
{
  "command": [           ← 実行されたコマンド
    "aws",
    "s3api", 
    "list-buckets",
    "--output",
    "json"
  ],
  "response": {          ← AWS APIの生レスポンス
    "Buckets": [
      {
        "Name": "my-bucket",
        "CreationDate": "2024-01-01T00:00:00.000Z"
      }
    ]
  },
  "timestamp": "2024-01-01T12:00:00+09:00",  ← キャッシュ作成時刻
  "ttl": 3600                                ← 有効期限（秒）
}
```

この図解により、AWS Cacheシステムの全体的な処理フローと各段階での詳細な動作が理解できます。